<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Table Data with Total Sum and Chart</title>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.1.2/echarts.min.js"></script>
	<style>
		table {
			width: 25%;
            justify-content: center;
			border-collapse: collapse;
		}

		tr:nth-child(2n) {
			background: #f0f0f0;
		}

		th,
		td {
			border: 1px solid black;
			padding: 8px;
			text-align: center;
			border-color: #e0e0e0;
		}

		.totals-row {
			font-weight: bold;
		}

        .chart-container {
            display: flex;
            flex-flow: row wrap; /* 가로 배치를 위한 속성 추가 */
            justify-content: center;
        }
         
	</style>
</head>
<body>
	<h1>1공정의 연간 합계: 재고, 정상품, 불량품, 장비가동률(평균)</h1>
	
	<table>
		<thead>
			<tr>
				<th>재고</th>
				<th>정상품</th>
				<th>불량품</th>
				<th>장비가동률</th>
			</tr>
		</thead>
		
		<tbody>
			<tr class="totals-row">
				<td class="stock-total"></td>
				<td class="tr-total"></td>
				<td class="fal-total"></td>
				<td class="opratio-avg"></td>
			</tr>
		</tbody>
		
	</table>

	<div class="chart-container">
	<div id="chartContainer" style="width: 700px;height: 300px;"></div>
	<div id="gaugeChart" style="width: 300px;height: 300px;"></div>
	</div>

	<script>
		let chart, gaugeChart;

		// 실시간 데이터 가져오기 ajax, 차트를 추가하면 여기에도 메소드를 추가해야 함
		function fetchData() {
			$.ajax({
				type: "GET",
				url: "select1.jsp",
				dataType: "json",
				success: function(response) {
					if (response.Error) {
						alert(response.Error);
					} else {
						let dataList = response;
						let tbody = $("table tbody");

						updateTableData(dataList); // 테이블 업데이트
						updateChart(dataList); // 차트 업데이트
						updateGaugeChart(dataList); // 게이지 차트 업데이트
					}
				},
				error: function(jqXHR, textStatus, errorThrown) {
					alert(`에러 발생: ${errorThrown}`);
				}
			});
			setTimeout(fetchData, 5000); // 5초마다 데이터 새로 고침
		}
		
				function updateTableData(dataList) {
			let total = {
				stock: 0,
				tr: 0,
				fal: 0,
			};
			let avg = {
				opratio: 0,
			};

			let rowCount = dataList.length;

			dataList.forEach(function(data) {
				const stock = parseInt(data.stock);
				const tr = parseInt(data.tr);
				const fal = parseInt(data.fal);
				const opratio = parseInt(data.opratio);

				total.stock += stock;
				total.tr += tr;
				total.fal += fal;
				avg.opratio += opratio;
			});

			const avgOpRatio = avg.opratio / rowCount;

			$("table .stock-total").text(total.stock);
			$("table .tr-total").text(total.tr);
			$("table .fal-total").text(total.fal);
			$("table .opratio-avg").text(avgOpRatio.toFixed(2));
		}
		
		// 월단위로 데이터 가져오기
		function calculateMonthlyData(dataList) {
		    var monthlyData = {};

		    dataList.forEach(function (data) {
		    	var date = new Date(data.hiredate); // 'hiredate' 속성을 사용하여 Date 객체 생성
		        var month = date.getMonth(); // 월 정보 (0부터 시작하므로, 나중에 1을 더해줘야 함)

		        if (!monthlyData[month]) {
		            monthlyData[month] = {
		                count: 0,
		                opratioSum: 0
		            };
		        }

		        monthlyData[month].count += 1;
		        monthlyData[month].opratioSum += parseInt(data.opratio);

		    });

		    return monthlyData;
		}
		
		// 월단위 데이터 평균내기
		function getMonthlyAverage(monthlyData) {
		    var monthlyAverage = [];

		    for (var month in monthlyData) {
		        var avg = monthlyData[month].opratioSum / monthlyData[month].count;
		        monthlyAverage[month] = avg;
		    }

		    return monthlyAverage;
		}

		// 가동률 바차트
		function updateChart(dataList) {
		    var monthlyData = calculateMonthlyData(dataList);
		    var monthlyAverage = getMonthlyAverage(monthlyData);

		    // 차트가 없을 경우에만 새로운 차트 생성
		    if (!chart) {
		        chart = echarts.init(document.getElementById("chartContainer"));
		    }

		    var option = {
		        xAxis: {
		            type: "category",
		            data: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"]
		        },
		        yAxis: {
		            type: "value"
		        },
		        series: [
		            {
		                data: monthlyAverage,
		                type: "bar",
	                	barWidth: "33%" 
		            }
		        ]
		    };

		    // 차트 옵션 설정 및 렌더링
		    chart.setOption(option);
		}
		
		// 게이지 차트
		function updateGaugeChart(dataList) {
	    let totalTemp = 0;
	    const rowCount = dataList.length;

	    dataList.forEach(function(data) {
	        totalTemp += parseFloat(data.temp); // parseFloat로 변경
	    });

	    const avgTemp = parseFloat((totalTemp / rowCount).toFixed(2)); // 계산 시 소수점 두 자리로 표시하도록 변경

		if (!gaugeChart) {
	        gaugeChart = echarts.init(document.getElementById('gaugeChart'));
	    }

	    const option = {
	    	series: [{
	    		type: 'gauge',
	    		min: 0,
	    		max: 15, 
	    		axisLine: {
	    			lineStyle: {
	    				width: 10,
	    				color: [
	    					[0.3, '#67e0e3'],
	    					[0.7, '#37a2da'],
	    					[1, '#fd666d']
	    				]
	    			}
	    		},
	    		pointer: {
	    			itemStyle: {
	    				color: 'auto'
	    			}
	    		},
	    		data: [{value: avgTemp, name: 'Temp'}]
	    	}]
	    };

	    gaugeChart.setOption(option);
	}

		$(document).ready(function(){
			fetchData();
		});
	</script>
</body>
</html>